name: Deploy to AWS Lightsail

on:
  push:
    branches:
    - main

jobs:
  verify-integrity:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate with Infisical via OIDC and fetch secrets
        uses: Infisical/secrets-action@v1.0.15
        with:
          method: oidc
          identity-id: "402c7253-b53d-47c8-8ca1-60ffb3406b32"
          domain: "https://app.infisical.com"
          env-slug: "prod"
          project-slug: "jobseeker-analytics-zec-y"

      - name: Verify Security Fingerprint
        env:
          EXPECTED_FINGERPRINT: ${{ env.EXPECTED_SECURITY_FINGERPRINT }}
          PYTHONPATH: ${{ github.workspace }}/backend
        run: |
          pip install pydantic pydantic-settings typing-extensions
          ACTUAL_FINGERPRINT=$(python3 -c "from config import settings; print(settings.get_security_fingerprint())")
          
          if [ "$ACTUAL_FINGERPRINT" != "$EXPECTED_FINGERPRINT" ]; then
            echo "::error title=Security Mismatch::Integrity unverified."
            exit 1
          fi

  deploy-backend:
    name: Deploy Backend
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-24.04
    environment: prod

    steps:
    - uses: actions/checkout@v4

    - name: Authenticate with Infisical via OIDC and fetch secrets
      uses: Infisical/secrets-action@v1.0.15
      with:
        method: oidc
        identity-id: "402c7253-b53d-47c8-8ca1-60ffb3406b32"
        domain: "https://app.infisical.com"
        env-slug: "prod"
        project-slug: "jobseeker-analytics-zec-y"

    - id: deploy
      uses: ./.github/actions/deploy-backend-to-lightsail
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-region: ${{ env.AWS_REGION }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        google-credentials-file-content: ${{ env.GOOGLE_CREDENTIALS_FILE_CONTENT }}
        ls-database-name: ${{ env.AWS_DATABASE_NAME }}
        cookie-secret: ${{ env.COOKIE_SECRET }}
        stripe-secret-key: ${{ env.STRIPE_SECRET_KEY }}
        stripe-webhook-secret: ${{ env.STRIPE_WEBHOOK_SECRET }}
        google-api-key: ${{ env.GOOGLE_API_KEY }}
        ipinfo-token: ${{ env.IPINFO_TOKEN }}
        app-url: ${{ env.APP_URL }}
        api-url: ${{ env.API_URL }}
        google-client-id: ${{ env.GOOGLE_CLIENT_ID }}
        google-client-secret: ${{ env.GOOGLE_CLIENT_SECRET }}
        google-client-redirect-uri: ${{ env.GOOGLE_CLIENT_REDIRECT_URI }}
        origin: ${{ env.ORIGIN }}
        token-encryption-key: ${{ env.TOKEN_ENCRYPTION_KEY }}

  deploy-frontend:
    name: Deploy Frontend
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-24.04
    environment: prod

    steps:
    - uses: actions/checkout@v4

    - name: Authenticate with Infisical via OIDC and fetch secrets
      uses: Infisical/secrets-action@v1.0.15
      with:
        method: oidc
        identity-id: "402c7253-b53d-47c8-8ca1-60ffb3406b32"
        domain: "https://app.infisical.com"
        env-slug: "prod"
        project-slug: "jobseeker-analytics-zec-y"

    - name: Deploy Frontend to Lightsail
      uses: ./.github/actions/deploy-frontend-to-lightsail
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        app-url: ${{ env.APP_URL }}
        api-url: ${{ env.API_URL }}
        gh-app-id: ${{ env.GH_APP_ID }}
        gh-private-key: ${{ env.GH_PRIVATE_KEY }}
        gh-installation-id: ${{ env.GH_INSTALLATION_ID }}
        posthog-key: ${{ env.NEXT_PUBLIC_POSTHOG_KEY }}
